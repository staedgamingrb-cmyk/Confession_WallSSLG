<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SSLG Confession Wall</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<!-- html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background:#fff0f5;
  margin:0;
  padding:20px;
}
h1{text-align:center;color:#ff4d88}
.card{
  max-width:500px;
  margin:auto;
  background:white;
  padding:20px;
  border-radius:20px;
}
input,textarea,button{
  width:100%;
  margin-top:10px;
  padding:10px;
  border-radius:10px;
  border:1px solid #ccc;
}
button{
  background:#ff4d88;
  color:white;
  border:none;
  cursor:pointer;
}
.admin{
  max-width:900px;
  margin:30px auto;
}
.conf{
  background:white;
  padding:15px;
  border-radius:15px;
  margin-bottom:10px;
}
.preview{
  width:470px;
  display:block;
  margin-top:10px;
  border-radius:10px;
}
.pagination button{
  width:auto;
  margin:5px;
}
</style>
</head>

<body>

<h1>ðŸ’– SSLG Confession Wall ðŸ’–</h1>

<div class="card">
  <input id="to" placeholder="To: (Name) Grade & Section">
  <input id="from" placeholder="From">
  <textarea id="msg" rows="5" placeholder="Your message..."></textarea>
  <button onclick="submitConfession()">Send Confession</button>
</div>

<hr>

<div class="card">
  <input id="adminPass" placeholder="Admin Password" type="password">
  <button onclick="login()">Open Admin Inbox</button>
</div>

<div id="admin" class="admin" style="display:none">
  <h2>ðŸ“¥ Admin Inbox</h2>
  <input id="search" placeholder="Search by sender (From)" oninput="render()">
  <div id="list"></div>
  <div class="pagination" id="pages"></div>
</div>

<!-- Hidden Image Card -->
<div id="imageCard" style="
display:none;
width:940px;
background:linear-gradient(145deg,#fff0f6,#ffe6ee);
border-radius:30px;
padding:60px;
box-sizing:border-box;
">
  <div style="background:white;border-radius:24px;padding:40px;">
    <h2 style="text-align:center;color:#ff4d88">Confession</h2>
    <p><strong>To:</strong> <span id="imgTo"></span></p>
    <p><strong>From:</strong> <span id="imgFrom"></span></p>
    <p id="imgMsg" style="margin-top:20px;line-height:1.6;white-space:pre-wrap;font-size:22px;"></p>
  </div>
  <div style="text-align:center;margin-top:20px;color:#ff4d88">
    by CCDCAGMNHS Supreme Secondary Learners Government
  </div>
</div>

<script>
// ðŸ”¥ Firebase Config
firebase.initializeApp({
  apiKey: "AIzaSyA2I8NIZ-5jcQBX_dvY3IA_Q43gcS1iWEA",
  authDomain: "g-confession-wall.firebaseapp.com",
  databaseURL: "https://g-confession-wall-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "g-confession-wall",
});

const db = firebase.database().ref("confessions");
let confessions=[], page=1;
const perPage=10;

// Submit
function submitConfession(){
  if(!to.value || !from.value || !msg.value) return alert("Complete all fields");
  db.push({to:to.value,from:from.value,msg:msg.value,time:Date.now()});
  to.value=from.value=msg.value="";
  alert("ðŸ’Œ Confession sent!");
}

// Admin Login
function login(){
  if(adminPass.value==="SSLGADMIN123123"){
    admin.style.display="block";
    load();
  }else alert("Wrong password");
}

// Load
function load(){
  db.on("value",s=>{
    confessions=[];
    s.forEach(c=>confessions.unshift({...c.val(),key:c.key}));
    render();
  });
}

// Render
function render(){
  const q=search.value.toLowerCase();
  const filtered=confessions.filter(c=>c.from.toLowerCase().includes(q));
  const start=(page-1)*perPage;
  const items=filtered.slice(start,start+perPage);

  list.innerHTML="";
  items.forEach(c=>{
    list.innerHTML+=`
      <div class="conf">
        <b>To:</b> ${c.to}<br>
        <b>From:</b> ${c.from}<br>
        <button onclick="preview('${c.key}')">Preview Image</button>
        <button onclick="del('${c.key}')">Delete</button>
        <img id="img-${c.key}" class="preview">
      </div>`;
  });

  pages.innerHTML="";
  for(let i=1;i<=Math.ceil(filtered.length/perPage);i++){
    pages.innerHTML+=`<button onclick="page=${i};render()">${i}</button>`;
  }
}

// Delete
function del(k){
  if(confirm("Delete confession?")) db.child(k).remove();
}

// Image Preview (ðŸ”¥ FIXED FOR LONG TEXT)
function preview(k){
  const c=confessions.find(x=>x.key===k);
  imgTo.innerText=c.to;
  imgFrom.innerText=c.from;
  imgMsg.innerText=c.msg;

  imageCard.style.display="block";

  setTimeout(()=>{
    html2canvas(imageCard).then(canvas=>{
      const final=document.createElement("canvas");
      final.width=940;
      final.height=788;
      final.getContext("2d").drawImage(canvas,0,0,canvas.width,canvas.height,0,0,940,788);
      document.getElementById("img-"+k).src=final.toDataURL();
      imageCard.style.display="none";
    });
  },100);
}
</script>

</body>
</html>
